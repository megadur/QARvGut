# Story 1.3: Admin User Management Interface

## Status
Draft

## Story
**As a** Platform Administrator,
**I want** a comprehensive admin interface for managing users, roles, and monitoring user activity,
**so that** I can efficiently administrate the platform with bulk operations, advanced search, and detailed user oversight capabilities.

## Acceptance Criteria
1. Admin dashboard provides user list with advanced search and filtering (department, role, status, date ranges)
2. Bulk operations interface supports user import/export (CSV/JSON), bulk role assignment, and bulk activation/deactivation
3. Individual user profile management with extended fields (firstName, lastName, email, role, department, phone, preferences)
4. User activity monitoring displays login history, activity timestamps, and session management
5. Interface follows existing Angular patterns and integrates with current admin routing structure
6. All admin operations respect role-based authorization and follow existing security patterns
7. Responsive design maintains consistency with existing Bootstrap 5 styling framework
8. 95% test coverage for new Angular components and admin API endpoints

## Tasks / Subtasks

- [ ] **Backend API Extensions** (AC: 1, 2, 3, 4, 6)
  - [ ] Extend UserAccountController with advanced search endpoint (`GET /api/account/users/search`)
  - [ ] Implement bulk operations endpoints (import, export, role assignment, activation)
  - [ ] Add user activity tracking endpoints with date filtering
  - [ ] Update existing profile management endpoint with extended fields
  - [ ] Apply existing authorization policies to all new endpoints
  - [ ] Follow existing response patterns and error handling conventions

- [ ] **Database Schema Extensions** (AC: 3, 4)
  - [ ] Create Entity Framework migration for extended User entity fields
  - [ ] Add activity tracking tables for user login/action history
  - [ ] Ensure backward compatibility with existing User entity
  - [ ] Test migration against existing data scenarios

- [ ] **Angular Admin Components** (AC: 1, 2, 3, 5, 7)
  - [ ] Create UserManagementDashboard component in existing controls folder
  - [ ] Implement advanced search/filter controls with form validation
  - [ ] Build bulk operations interface (import/export, bulk actions)
  - [ ] Create user profile editing forms with extended field validation
  - [ ] Integrate with existing admin routing in SettingsComponent extension
  - [ ] Apply existing Bootstrap 5 styling patterns for consistency

- [ ] **User Activity Monitoring** (AC: 4, 7)
  - [ ] Create UserActivityDisplay component for activity history
  - [ ] Implement activity timeline with filtering capabilities
  - [ ] Add session management controls for admin oversight
  - [ ] Ensure responsive design for activity data tables

- [ ] **Testing Implementation** (AC: 8)
  - [ ] Unit tests for new controller endpoints following existing patterns
  - [ ] Integration tests for bulk operations and search functionality
  - [ ] Angular component tests for new dashboard components
  - [ ] Regression tests to ensure existing user management remains functional

## Dev Notes

### Previous Story Insights
From Story 1.2 completion: Enhanced User entity structure is already established with comprehensive profile fields. Authentication middleware and role-based authorization patterns are proven and should be consistently applied to new admin endpoints.

### Data Models
**Extended ApplicationUser Entity** [Source: brownfield-architecture/component-architecture.md#enhanced-user-data-layer]
- Enhanced ApplicationUser entity with profile fields (firstName, lastName, email, role, department, phone, preferences)
- Activity tracking tables for login history and user actions
- Maintained compatibility with existing UserAccountService patterns
- Entity Framework migrations for schema extensions required

### API Specifications
**Admin Management Endpoints** [Source: brownfield-architecture/api-design-and-endpoints.md#enhanced-user-management-api-endpoints]
- `POST /api/account/users/bulk-import` - Import users from CSV/JSON
- `POST /api/account/users/bulk-roles` - Bulk role assignment  
- `POST /api/account/users/bulk-activate` - Bulk activation/deactivation
- `GET /api/account/users/export` - Export users with filtering
- `GET /api/account/users/search?department={}&role={}&status={}&page={}` - Advanced search
- `GET /api/account/users/activity?fromDate={}&toDate={}` - Activity reports
- `PUT /api/account/users/{id}/profile` - Update extended profile
- `GET /api/account/users/{id}/activity` - User activity history

**Authorization Requirements:** All endpoints use existing authorization patterns: `[Authorize(AuthPolicies.ViewAllUsersPolicy)]` and similar role-based policies

### Component Specifications
**Angular Admin Components** [Source: brownfield-architecture/component-architecture.md#user-management-dashboard-components]
- **Location:** Existing controls folder following current component structure
- **Integration:** Extends SettingsComponent and existing admin controls
- **Routing:** Integrates with existing Angular admin routing patterns
- **Styling:** Bootstrap 5 framework for consistency with existing UI
- **Components Required:**
  - User list with advanced search/filter controls
  - Profile editing forms with validation
  - Activity tracking displays  
  - Bulk operation interfaces

### File Locations
**Backend Extensions** [Source: brownfield-architecture/development-guidelines.md#code-organization]
- Controller: Extend existing `UserAccountController` in Controllers folder
- Models: Enhanced `ApplicationUser` in `Core.Models.Account` namespace
- Authorization: Use existing `AuthPolicies` patterns

**Frontend Components** [Source: brownfield-architecture/development-guidelines.md#naming-conventions]
- Components: New components in existing `controls` folder structure
- Naming: Follow existing `*-management.component` pattern
- Services: Extend existing HTTP services for API communication

### Technical Constraints
**Technology Stack** [Source: brownfield-architecture/tech-stack-alignment.md]
- Angular 19 for frontend components
- ASP.NET Core 9.0 for API extensions
- PostgreSQL with Entity Framework Core for data layer
- Bootstrap 5 for UI styling consistency
- Existing ASP.NET Identity + OpenIDConnect for authentication

**Integration Requirements:**
- Maintain backward compatibility with existing User entity
- Follow existing authentication and authorization patterns
- Preserve current API response formats and error handling
- Integrate with existing Angular component architecture

### Testing Requirements
**Testing Strategy** [Source: brownfield-architecture/testing-strategy.md]
- **Unit Testing:** Test new User entity properties, controller extensions, and service layer bulk operations
- **Integration Testing:** Database migrations, API endpoint integration with authentication, frontend component integration
- **Regression Testing:** Ensure existing user management functionality remains unaffected
- **Coverage Target:** 95% test coverage for new components and endpoints

**Test File Locations:** Follow existing testing patterns in QARvGut.Tests project structure

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-13 | 1.0 | Initial story creation for admin user management interface | Bob (Scrum Master) |
