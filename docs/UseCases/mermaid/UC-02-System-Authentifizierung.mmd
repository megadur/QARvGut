sequenceDiagram
    participant USR as Benutzer
    participant RVG as rvGutachten System
    participant DB as Datenbank
    participant SSN as Session Manager
    participant EML as E-Mail System

    Note over U,ES: UC02 Benutzer-Anmeldung am System

    USR->>RVG: 01. Login-Seite aufrufen
    RVG->>USR: 02. Login-Formular anzeigen

    USR->>RVG: 03. E-Mail und Passwort eingeben
    RVG->>RVG: 04. Eingaben validieren (Format, Pflichtfelder)

    alt Ungültige Eingaben
        RVG->>USR: 5a. Validierungsfehler anzeigen
    else Eingaben gültig
        RVG->>DB: 5b. Benutzer-Authentifizierung (E-Mail, Passwort-Hash)
        DB->>RVG: 06. Authentifizierungsresultat

        alt Falsche Anmeldedaten
            RVG->>RVG: 7a. Fehlversuch zählen
            alt Zu viele Fehlversuche (>3)
                RVG->>DB: 8a. Account temporär sperren (30 Min)
                RVG->>USR: 9a. Account gesperrt - Wartezeit
            else Normale Fehlermeldung
                RVG->>USR: 8b. Anmeldedaten falsch
            end
        else Account gesperrt
            RVG->>USR: 7b. Account gesperrt - Kontakt Information
        else Authentifizierung erfolgreich
            RVG->>DB: 7c. Account-Status prüfen (aktiv/gesperrt)
            DB->>RVG: 8c. Status-Information

            alt Account nicht aktiv
                RVG->>USR: 9c. Account inaktiv - Kontakt Support
            else Account aktiv
                RVG->>SSN: 9d. Session erstellen
                SSN->>RVG: 10. Session-Token + Security-Token

                alt "Angemeldet bleiben" gewählt
                    RVG->>SSN: 11a. Extended Session (7 Tage)
                else Standard Session
                    RVG->>SSN: 11b. Standard Session (8 Stunden)
                end

                RVG->>DB: 12. Login-Zeitstempel + IP-Adresse speichern
                RVG->>RVG: 13. Audit-Log erstellen

                alt Erster Login
                    RVG->>USR: 14a. Passwort-Änderung erforderlich
                else Verdächtige Anmeldung (neue IP/Gerät)
                    RVG->>EML: 14b. Sicherheitsbenachrichtigung senden
                    EML->>USR: 15. E-Mail über neue Anmeldung
                    RVG->>USR: 16. Zusätzliche Verifikation erforderlich
                else Normale Anmeldung
                    RVG->>USR: 14c. Weiterleitung zur Auftragsübersicht
                end
            end
        end
    end

    Note over U,ES: Passwort vergessen (Erweiterte Funktion)
    alt Passwort vergessen
        USR->>RVG: 17. "Passwort vergessen" klicken
        USR->>RVG: 18. E-Mail-Adresse eingeben
        RVG->>DB: 19. E-Mail validieren
        alt E-Mail existiert
            RVG->>RVG: 20a. Reset-Token generieren
            RVG->>EML: 21. Reset-E-Mail senden
            EML->>USR: 22. E-Mail mit Reset-Link
        else E-Mail unbekannt
            RVG->>USR: 20b. Allgemeine Bestätigungsmeldung (Security)
        end
    end