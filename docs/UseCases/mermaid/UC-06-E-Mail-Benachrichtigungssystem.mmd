sequenceDiagram
    participant SYS as System Event
    participant RVG as rvGutachten System
    participant NTF as Notification Manager
    participant TPL as Template Manager
    participant DB as Datenbank
    participant EML as E-Mail System
    participant GUT as Gutachter/Benutzer

    Note over SYS,G: UC06 Automatische E-Mail-Benachrichtigungen

    SYS->>RVG: 01. Triggering Event (Neuer Auftrag/Status/Mahnung)
    RVG->>NTF: 02. Event zur Verarbeitung weiterleiten

    NTF->>DB: 03. Betroffenen Gutachter ermitteln
    DB->>NTF: 04. Gutachterliste + E-Mail-Präferenzen

    alt Benutzer hat Benachrichtigungen deaktiviert
        NTF->>RVG: 5a. Event ignorieren (Opt-out respektieren)
    else Benachrichtigungen aktiv
        NTF->>TPL: 5b. Geeignetes E-Mail-Template bestimmen

        alt Neuer Auftrag zugewiesen
            TPL->>TPL: 6a. Template "Neuer Auftrag" laden
            TPL->>DB: 7a. Auftragsdaten für Platzhalter abrufen
            DB->>TPL: 8a. {{auftrag_nummer}}, {{proband_name}}, {{frist_datum}}

        else Auftragsstatus geändert
            TPL->>TPL: 6b. Template "Statusänderung" laden
            TPL->>DB: 7b. Statusdaten abrufen
            DB->>TPL: 8b. Alter/Neuer Status, Zeitstempel

        else Mahnung eingegangen
            TPL->>TPL: 6c. Template "Mahnung" (Priorität) laden
            TPL->>DB: 7c. Mahnungsdaten abrufen
            DB->>TPL: 8c. Mahnstufe, Fristdaten, Eskalationsstufe

        else System-Wartung
            TPL->>TPL: 6d. Template "System-Info" laden
            TPL->>DB: 7d. Wartungsdetails abrufen
            DB->>TPL: 8d. Wartungsfenster, betroffene Services
        end

        TPL->>TPL: 09. Platzhalter ersetzen ({{gutachter_name}}, {{link_portal}})
        TPL->>NTF: 10. Personalisierte Nachricht erstellen

        NTF->>EML: 11. E-Mail versenden
        alt SMTP-Fehler
            EML->>NTF: 12a. Versandfehler
            NTF->>NTF: 13a. Retry-Mechanismus (3 Versuche)
            alt Max. Versuche erreicht
                NTF->>DB: 14a. Fehlerhafte E-Mail-Adresse markieren
                NTF->>RVG: 15a. Admin über Versandfehler informieren
            else Retry erfolgreich
                EML->>GUT: 14b. E-Mail zugestellt
                NTF->>DB: 15b. Erfolgreichen Versand protokollieren
            end
        else Versand erfolgreich
            EML->>GUT: 12b. E-Mail zugestellt
            NTF->>DB: 13b. Versand im Audit-Log protokollieren
        end
    end

    Note over SYS,G: Konfigurierbare Einstellungen

    alt Administrator konfiguriert Templates
        participant ADM as Administrator
        DRV->>TPL: 16. Template bearbeiten
        TPL->>DB: 17. Neue Template-Version speichern
        TPL->>DRV: 18. Änderungen bestätigt

    else Gutachter ändert Präferenzen
        GUT->>RVG: 19. Benachrichtigungseinstellungen öffnen
        RVG->>DB: 20. Aktuelle Präferenzen laden
        DB->>RVG: 21. Einstellungen (Frequenz, Opt-outs)
        RVG->>GUT: 22. Einstellungsformular anzeigen

        GUT->>RVG: 23. Präferenzen ändern (täglich/sofort/wöchentlich)
        RVG->>DB: 24. Neue Präferenzen speichern
        RVG->>GUT: 25. Änderungen bestätigt
    end
